"use strict";

var cov_2rmbh0ewmh = function () {
  var path = "/home/local/pyykkomi/liiga/backend/services/update/matches.js";
  var hash = "4997b7770a292428ea0955a118d1e80812237b68";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/home/local/pyykkomi/liiga/backend/services/update/matches.js",
    statementMap: {
      "0": {
        start: {
          line: 15,
          column: 26
        },
        end: {
          line: 29,
          column: 1
        }
      },
      "1": {
        start: {
          line: 16,
          column: 23
        },
        end: {
          line: 16,
          column: 82
        }
      },
      "2": {
        start: {
          line: 16,
          column: 70
        },
        end: {
          line: 16,
          column: 80
        }
      },
      "3": {
        start: {
          line: 18,
          column: 27
        },
        end: {
          line: 26,
          column: 6
        }
      },
      "4": {
        start: {
          line: 21,
          column: 25
        },
        end: {
          line: 21,
          column: 71
        }
      },
      "5": {
        start: {
          line: 21,
          column: 48
        },
        end: {
          line: 21,
          column: 70
        }
      },
      "6": {
        start: {
          line: 25,
          column: 6
        },
        end: {
          line: 25,
          column: 60
        }
      },
      "7": {
        start: {
          line: 28,
          column: 2
        },
        end: {
          line: 28,
          column: 122
        }
      },
      "8": {
        start: {
          line: 28,
          column: 66
        },
        end: {
          line: 28,
          column: 102
        }
      },
      "9": {
        start: {
          line: 28,
          column: 118
        },
        end: {
          line: 28,
          column: 121
        }
      },
      "10": {
        start: {
          line: 31,
          column: 36
        },
        end: {
          line: 107,
          column: 1
        }
      },
      "11": {
        start: {
          line: 42,
          column: 2
        },
        end: {
          line: 106,
          column: 4
        }
      },
      "12": {
        start: {
          line: 53,
          column: 8
        },
        end: {
          line: 53,
          column: 13
        }
      },
      "13": {
        start: {
          line: 55,
          column: 39
        },
        end: {
          line: 55,
          column: 49
        }
      },
      "14": {
        start: {
          line: 56,
          column: 40
        },
        end: {
          line: 56,
          column: 51
        }
      },
      "15": {
        start: {
          line: 65,
          column: 4
        },
        end: {
          line: 105,
          column: 5
        }
      },
      "16": {
        start: {
          line: 109,
          column: 29
        },
        end: {
          line: 111,
          column: 1
        }
      },
      "17": {
        start: {
          line: 110,
          column: 2
        },
        end: {
          line: 110,
          column: 68
        }
      },
      "18": {
        start: {
          line: 110,
          column: 30
        },
        end: {
          line: 110,
          column: 50
        }
      },
      "19": {
        start: {
          line: 110,
          column: 64
        },
        end: {
          line: 110,
          column: 67
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 15,
            column: 26
          },
          end: {
            line: 15,
            column: 27
          }
        },
        loc: {
          start: {
            line: 15,
            column: 73
          },
          end: {
            line: 29,
            column: 1
          }
        },
        line: 15
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 16,
            column: 65
          },
          end: {
            line: 16,
            column: 66
          }
        },
        loc: {
          start: {
            line: 16,
            column: 70
          },
          end: {
            line: 16,
            column: 80
          }
        },
        line: 16
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 20,
            column: 21
          },
          end: {
            line: 20,
            column: 22
          }
        },
        loc: {
          start: {
            line: 20,
            column: 30
          },
          end: {
            line: 26,
            column: 5
          }
        },
        line: 20
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 21,
            column: 43
          },
          end: {
            line: 21,
            column: 44
          }
        },
        loc: {
          start: {
            line: 21,
            column: 48
          },
          end: {
            line: 21,
            column: 70
          }
        },
        line: 21
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 28,
            column: 49
          },
          end: {
            line: 28,
            column: 50
          }
        },
        loc: {
          start: {
            line: 28,
            column: 66
          },
          end: {
            line: 28,
            column: 102
          }
        },
        line: 28
      },
      "5": {
        name: "(anonymous_5)",
        decl: {
          start: {
            line: 28,
            column: 113
          },
          end: {
            line: 28,
            column: 114
          }
        },
        loc: {
          start: {
            line: 28,
            column: 118
          },
          end: {
            line: 28,
            column: 121
          }
        },
        line: 28
      },
      "6": {
        name: "(anonymous_6)",
        decl: {
          start: {
            line: 31,
            column: 36
          },
          end: {
            line: 31,
            column: 37
          }
        },
        loc: {
          start: {
            line: 41,
            column: 8
          },
          end: {
            line: 107,
            column: 1
          }
        },
        line: 41
      },
      "7": {
        name: "(anonymous_7)",
        decl: {
          start: {
            line: 42,
            column: 21
          },
          end: {
            line: 42,
            column: 22
          }
        },
        loc: {
          start: {
            line: 42,
            column: 30
          },
          end: {
            line: 106,
            column: 3
          }
        },
        line: 42
      },
      "8": {
        name: "(anonymous_8)",
        decl: {
          start: {
            line: 109,
            column: 29
          },
          end: {
            line: 109,
            column: 30
          }
        },
        loc: {
          start: {
            line: 109,
            column: 57
          },
          end: {
            line: 111,
            column: 1
          }
        },
        line: 109
      },
      "9": {
        name: "(anonymous_9)",
        decl: {
          start: {
            line: 110,
            column: 21
          },
          end: {
            line: 110,
            column: 22
          }
        },
        loc: {
          start: {
            line: 110,
            column: 30
          },
          end: {
            line: 110,
            column: 50
          }
        },
        line: 110
      },
      "10": {
        name: "(anonymous_10)",
        decl: {
          start: {
            line: 110,
            column: 59
          },
          end: {
            line: 110,
            column: 60
          }
        },
        loc: {
          start: {
            line: 110,
            column: 64
          },
          end: {
            line: 110,
            column: 67
          }
        },
        line: 110
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 15,
            column: 42
          },
          end: {
            line: 15,
            column: 68
          }
        },
        type: "default-arg",
        locations: [{
          start: {
            line: 15,
            column: 52
          },
          end: {
            line: 15,
            column: 68
          }
        }],
        line: 15
      },
      "1": {
        loc: {
          start: {
            line: 18,
            column: 27
          },
          end: {
            line: 26,
            column: 6
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 19,
            column: 6
          },
          end: {
            line: 19,
            column: 13
          }
        }, {
          start: {
            line: 20,
            column: 6
          },
          end: {
            line: 26,
            column: 6
          }
        }],
        line: 18
      },
      "2": {
        loc: {
          start: {
            line: 25,
            column: 13
          },
          end: {
            line: 25,
            column: 60
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 25,
            column: 13
          },
          end: {
            line: 25,
            column: 24
          }
        }, {
          start: {
            line: 25,
            column: 28
          },
          end: {
            line: 25,
            column: 60
          }
        }],
        line: 25
      },
      "3": {
        loc: {
          start: {
            line: 35,
            column: 2
          },
          end: {
            line: 41,
            column: 3
          }
        },
        type: "default-arg",
        locations: [{
          start: {
            line: 35,
            column: 12
          },
          end: {
            line: 41,
            column: 3
          }
        }],
        line: 35
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0
    },
    b: {
      "0": [0],
      "1": [0, 0],
      "2": [0, 0],
      "3": [0]
    },
    _coverageSchema: "43e27e138ebf9cfc5966b082cf9a028302ed4184",
    hash: "4997b7770a292428ea0955a118d1e80812237b68"
  };
  var coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getForMatches = exports.getUpdateableMatches = exports.getMatches = void 0;

var _api = _interopRequireDefault(require("api"));

var _models = require("models");

var _lodash = _interopRequireDefault(require("lodash"));

var _teams = require("./teams");

var _players = require("./players");

var _goals = require("./goals");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

cov_2rmbh0ewmh.s[0]++;

var getMatches =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee2(matches) {
    var options,
        foundMatches,
        fetchableMatches,
        _args2 = arguments;
    return regeneratorRuntime.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            options = _args2.length > 1 && _args2[1] !== undefined ? _args2[1] : (cov_2rmbh0ewmh.b[0][0]++, {
              force: false
            });
            cov_2rmbh0ewmh.f[0]++;
            cov_2rmbh0ewmh.s[1]++;
            _context2.next = 5;
            return _models.Match.query().findByIds(matches.map(function (m) {
              cov_2rmbh0ewmh.f[1]++;
              cov_2rmbh0ewmh.s[2]++;
              return m.match_id;
            }));

          case 5:
            foundMatches = _context2.sent;
            fetchableMatches = (cov_2rmbh0ewmh.s[3]++, options.force ? (cov_2rmbh0ewmh.b[1][0]++, matches) : (cov_2rmbh0ewmh.b[1][1]++, matches.filter(function (match) {
              cov_2rmbh0ewmh.f[2]++;
              var foundMatch = (cov_2rmbh0ewmh.s[4]++, foundMatches.find(function (m) {
                cov_2rmbh0ewmh.f[3]++;
                cov_2rmbh0ewmh.s[5]++;
                return m.id == match.match_id;
              })); // TODO: more criteria on when to fetch --- more complete stats etc.
              // TODO: don't try to get matches after current date

              cov_2rmbh0ewmh.s[6]++;
              return (cov_2rmbh0ewmh.b[2][0]++, !foundMatch) || (cov_2rmbh0ewmh.b[2][1]++, match.status > foundMatch.status);
            })));
            cov_2rmbh0ewmh.s[7]++;
            _context2.next = 10;
            return Promise.all(fetchableMatches.map(
            /*#__PURE__*/
            function () {
              var _ref2 = _asyncToGenerator(
              /*#__PURE__*/
              regeneratorRuntime.mark(function _callee(match) {
                return regeneratorRuntime.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        cov_2rmbh0ewmh.f[4]++;
                        cov_2rmbh0ewmh.s[8]++;
                        _context.next = 4;
                        return _api["default"].fetchMatch(match.match_id);

                      case 4:
                        return _context.abrupt("return", _context.sent);

                      case 5:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee);
              }));

              return function (_x2) {
                return _ref2.apply(this, arguments);
              };
            }()));

          case 10:
            _context2.t0 = function (v) {
              cov_2rmbh0ewmh.f[5]++;
              cov_2rmbh0ewmh.s[9]++;
              return !!v;
            };

            return _context2.abrupt("return", _context2.sent.filter(_context2.t0));

          case 12:
          case "end":
            return _context2.stop();
        }
      }
    }, _callee2);
  }));

  return function getMatches(_x) {
    return _ref.apply(this, arguments);
  };
}();

exports.getMatches = getMatches;
cov_2rmbh0ewmh.s[10]++;

var getUpdateableMatches =
/*#__PURE__*/
function () {
  var _ref3 = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee3(matches, tournament_id, season_id) {
    var options,
        _args3 = arguments;
    return regeneratorRuntime.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            options = _args3.length > 3 && _args3[3] !== undefined ? _args3[3] : (cov_2rmbh0ewmh.b[3][0]++, {
              teamStatistics: false,
              teamInfo: false,
              teamTactics: false,
              playerStatistics: false,
              goals: false
            });
            cov_2rmbh0ewmh.f[6]++;
            cov_2rmbh0ewmh.s[11]++;
            return _context3.abrupt("return", matches.map(function (match) {
              cov_2rmbh0ewmh.f[7]++;

              var _ref4 = (cov_2rmbh0ewmh.s[12]++, match),
                  first_team = _ref4.first_team,
                  second_team = _ref4.second_team,
                  score_first_team = _ref4.score_first_team,
                  score_second_team = _ref4.score_second_team,
                  match_id = _ref4.match_id,
                  status = _ref4.status,
                  round = _ref4.round,
                  date = _ref4.date,
                  min = _ref4.min;

              var _ref5 = (cov_2rmbh0ewmh.s[13]++, first_team),
                  first_team_id = _ref5.team_id;

              var _ref6 = (cov_2rmbh0ewmh.s[14]++, second_team),
                  second_team_id = _ref6.team_id; // TODO: get these away or in any case don't run when not needed

              /*     const [home_statistics, away_statistics] = ['first', 'second'].map(t => getTeamStatistics(match, t))
                  const [home_team_info, away_team_info] = ['first', 'second'].map(t => getTeamInfo(match, t))
                  const [home_team_tactics, away_team_tactics] = [first_team_id, second_team_id].map(t => getTeamTactics(match, t))
                  const [home_players, away_players] = [first_team_id, second_team_id].map(t => getPlayerStatisticsForTeam(match, t))
                  const goals = getMatchGoals(match) */


              cov_2rmbh0ewmh.s[15]++;
              return {
                id: match_id,
                tournament_id: Number(tournament_id),
                season_id: Number(season_id),
                round: round,
                date: date,
                status: status,
                min: min,
                home_team_id: first_team_id,
                away_team_id: second_team_id,
                home_score: score_first_team,
                away_score: score_second_team // TODO: separate...

                /*       home_statistics: options.teamStatistics
                        ? home_statistics
                        : null,
                      away_statistics: options.teamStatistics 
                        ? away_statistics
                        : null,
                      home_team_info: options.teamInfo
                        ? home_team_info
                        : null,
                      away_team_info: options.teamInfo
                        ? away_team_info
                        : null,
                      home_team_tactics: options.teamTactics
                        ? home_team_tactics
                        : null,
                      away_team_tactics: options.teamTactics
                        ? away_team_tactics
                        : null,
                      home_players: options.playerStatistics
                        ? home_players
                        : null,
                      away_players: options.playerStatistics
                        ? away_players
                        : null,
                      goals: options.goals
                        ? goals
                        : null */

              };
            }));

          case 4:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));

  return function getUpdateableMatches(_x3, _x4, _x5) {
    return _ref3.apply(this, arguments);
  };
}();

exports.getUpdateableMatches = getUpdateableMatches;
cov_2rmbh0ewmh.s[16]++;

var getForMatches = function getForMatches(matches, fn) {
  for (var _len = arguments.length, params = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {
    params[_key - 2] = arguments[_key];
  }

  cov_2rmbh0ewmh.f[8]++;
  cov_2rmbh0ewmh.s[17]++;
  return matches.map(function (match) {
    cov_2rmbh0ewmh.f[9]++;
    cov_2rmbh0ewmh.s[18]++;
    return fn.apply(void 0, [match].concat(params));
  }).filter(function (v) {
    cov_2rmbh0ewmh.f[10]++;
    cov_2rmbh0ewmh.s[19]++;
    return !!v;
  });
};

exports.getForMatches = getForMatches;